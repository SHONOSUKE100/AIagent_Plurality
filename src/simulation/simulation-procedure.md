## シミュレーション手順と入出力

### エージェント構成
- 体数: 100体（デフォルト）。
- コンテクスト（各エージェントが持つ情報）:
  - ペルソナ: `occupations` / `hobbies` / `residence` / `profile`（`data/persona/persona.json` から読み込み）。
  - 自己埋め込み: ペルソナ文面から生成したベクトル（埋め込みを有効にした場合）。
- 記憶: 直近の投稿・コメント・ツール呼び出しの履歴（LLMが行動を選ぶ際の入力に含まれる）。過去10件程度までに抑制。
- 投稿/コメント履歴: データベース上の自身の投稿・コメント・いいね履歴。プロンプト投入は直近10件程度までに限定。
  - 推薦コンテクスト: 推薦アルゴリズムが渡すおすすめ投稿の一覧（行動決定時に提示される）。

### 入力と出力
- 入力（LLMへのプロンプトに含まれる主な要素）:
  - 上記コンテクスト（ペルソナ、記憶、推薦結果）。
  - 利用可能なアクション一覧とパラメータ仕様。
  - 環境から取得した投稿/コメントの抜粋（検索やトレンド参照時）。
- 出力:
  - 選択されたアクションとその引数（例: CREATE_POST の content）。
  - 環境への副作用: 投稿・コメント・いいね・フォロー等が SQLite に記録され、次ラウンドの推薦や埋め込み更新の入力になる。

### 取れる行動（ActionType）
- LIKE_POST, DISLIKE_POST, CREATE_POST, CREATE_COMMENT, LIKE_COMMENT, DISLIKE_COMMENT,
  SEARCH_POSTS, SEARCH_USER, TREND, REFRESH, DO_NOTHING, FOLLOW, MUTE

### 推薦アルゴリズム
- `random` / `collaborative` / `bridging` のいずれかを選択。
- 推薦結果は各ラウンド開始時に対象エージェントへ提示され、行動選択の参考情報としてプロンプトに入る。

### シミュレーション手順
1. **初期化**
   - 100体のエージェントを生成し、ペルソナを読み込み。
   - `seed_post_count=20` のデフォルトでは、100体からランダムに20体を選び、シード投稿を作成。
   - 埋め込みを有効にしている場合は、ペルソナとシード投稿に対して埋め込みを計算。
2. **LLMラウンド（各ラウンドで実施）**
   - 全エージェントのうち `agent_action_ratio`（デフォルト0.3）に応じてランダムに行動対象を抽出。
   - 推薦アルゴリズムが各対象エージェントに投稿リストを提示。
   - 各エージェントは上記コンテクストを含むプロンプトを受け取り、1つのアクションを選択し実行。
   - 新規投稿・コメントが生まれた場合、埋め込みを逐次更新（ランダム推薦のみ実験後一括）。
3. **ラウンド終了後**
   - 次ラウンドに向けて最新の投稿/コメント/埋め込みが推薦や検索の入力となる。

### 成果物
- `simulation.db`: 投稿・コメント・フォロー・推薦ログ (`rec` テーブル) など全行動の記録。
- `metadata.yaml`: 実験設定とステータス。
- `results/latest_run.txt`: 最新実験ディレクトリへのポインタ。
- `step_metrics.csv`: シード後と各ラウンド後のグラフ指標（ノード/エッジ数、密度、クラスタ係数、モジュラリティなど）を時系列で記録。
- `step_snapshots/`: シード完了後・各ラウンド後・最終時点の SQLite スナップショット（`after_seeding.db`, `round_N.db`, `final.db`）を保存。後から任意のタイミングの状態で評価・可視化に利用できる。
